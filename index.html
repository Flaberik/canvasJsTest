<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Canvas tutorial</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script type="text/javascript">
      var width; // Ширина
      var height; // высота
      var racket_hei = 120;

      var game;
      var canvas;
      var ctx;

      var dX_p1;
      var dX_p2;
      var dY_p1;
      var dY_p2;

      function initialize_game() {
        var canvas = document.getElementById('tutorial');
        width = document.body.clientWidth;
        height = 600;

        canvas.width = width;
        canvas.height = height;

        dX_p1 = 20;
        dX_p2 = width-40;

        dY_p1 = height/2-racket_hei/2;
        dY_p2 = height/2-racket_hei/2;

        if (canvas.getContext) {
          ctx = canvas.getContext('2d');
          game = true;
          game_loop();
        }
      }

      async function game_loop(){
        while(game){
          render();
          await sleep(1000/60); // {1000ms / 60} ~ 60FPS
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function render(){
          render_scene();
          player_render(dX_p1, dY_p1);
          player_render(dX_p2, dY_p2)
      }

      function render_scene(){
        ctx.fillStyle = 'rgb(0, 0, 0)';
        ctx.strokeStyle = 'rgb(128, 128, 128)';
        ctx.fillRect(0, 0, width, height);

        ctx.beginPath();
        ctx.moveTo(0, height/2);
        ctx.lineTo(width, height/2);
        ctx.moveTo(width/2, 0);
        ctx.lineTo(width/2, height);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(width/2, height/2, 100, 0, Math.PI * 2, true);
        ctx.stroke();
      }

      function player_render(x,y){
        ctx.fillStyle = 'rgb(128, 128, 128)';
        ctx.fillRect(x, y, 20, racket_hei);
      }

      function move_player(code){
        switch(code){
          case 87: // KeyW
            dY_p1 = update_dY(dY_p1, -2);
            break;
          case 83: //KeyS
            dY_p1 = update_dY(dY_p1, 2);
            break;
        }

        switch(code){
          case 38: //ArrowUp
            dY_p2 = update_dY(dY_p2, -2);
            break;
          case 40: //ArrowDown
            dY_p2 = update_dY(dY_p2, 2);
            break;
        }

      }

    function update_dY(dy, step){
      if((dy+step + (racket_hei) <= height && step > 0) || (dy+step >= 0 && step < 0))
        return (dy+step);
      return dy;
    }


    var keys = [];
    $(document).keydown(function(e){
        var code = e.which;
        if (keys.indexOf(code)<0){
            keys.push(code);
        }

        if(keys[0] && keys[1]){
          move_player(keys[0]);
          move_player(keys[1]);
        }else if(keys[0]){
          move_player(keys[0]);
        }
    });

    $(document).keyup(function(e){
      keys.splice(keys.indexOf(e.which),1);
    });
    //addEventListener("keydown", move_p1);
    // function runOnKeys(func, ...codes) {
    //   let pressed = new Set();
    //   addEventListener("keydown", function(event){
    //      pressed.add(event.code);
    //
    //      for (let code of codes) { // are all keys in the set?
    //        if (!pressed.has(code)) {
    //          return;
    //        }
    //      }
    //   });
    // }

    //
    // function runOnKeys(func, ...codes) {
    //   let pressed = new Set();
    //
    //     document.addEventListener('keydown', function(event) {
    //       pressed.add(event.code);
    //
    //       for (let code of codes) { // are all keys in the set?
    //         console.log(pressed.has(code))
    //         if (!pressed.has(code)) {
    //           return
    //         }else{
    //           pressed.clear();
    //           func();
    //         }
    //       }
    //
    //
    //
    //     });
    //
    //   document.addEventListener('keydown', function(event) {
    //     pressed.delete(event.code);
    //   });
    //
    // }
    //
    // runOnKeys(
    //   () => (dY_p1 = update_dY(dY_p1, -2)),//{dY_p1 = update_dY(dY_p1, -2);dY_p2 = update_dY(dY_p2, -2);},
    //   "KeyW",
    //   "ArrowUp"
    // );
    // document.addEventListener('keydown',move_p1)
    </script>
    <style type="text/css">
      canvas { border: 1px solid black; }
    </style>
  </head>
  <body onload="initialize_game();" style="padding:0px;">
    <canvas id="tutorial" width="1" height="1" style="margin-top: 20px;"></canvas>
  </body>
</html>
